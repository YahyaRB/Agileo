<div>
  <div class="container mt-4">
    <!-- En-tête de la demande -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row mb-1">
          <div class="col-md-6">
            <h5 class="text-muted mb-2">Numéro de demande</h5>
            <p class="font-weight-bold">DA-{{ selectedDemandeAchat?.id?.toString().padStart(4, '0') }}</p>
          </div>
          <div class="col-md-6">
            <h5 class="text-muted mb-1">Statut</h5>
            <p><strong>Statut : </strong>
              <span class="badge"
                    [ngClass]="{
                      'badge-secondary': selectedDemandeAchat?.statut === 0,
                      'badge-warning': selectedDemandeAchat?.statut === 1,
                      'badge-danger': selectedDemandeAchat?.statut === -1
                    }">
                {{ selectedDemandeAchat?.statutLabel || selectedDemandeAchat?.statut || 'N/A' }}
              </span>
            </p>
          </div>
        </div>

        <div class="row mb-1">
          <div class="col-md-12">
            <h5 class="text-muted mb-1">Affaire/Chantier</h5>
            <p> {{ affaireByDemandeAchat.affaire }} - {{ affaireByDemandeAchat.libelle }} </p>
          </div>
        </div>

        <div class="row mb-1">
          <div class="col-md-6">
            <h5 class="text-muted mb-1">Date de création</h5>
            <p>{{ (selectedDemandeAchat?.sysCreationDate | date:'yyyy-MM-dd') }}</p>
          </div>
          <div class="col-md-6">
            <h5 class="text-muted mb-1">Délai souhaité</h5>
            <p>{{ selectedDemandeAchat?.delaiSouhaite | date:'yyyy-MM-dd' }}</p>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <!-- Indicateur de chargement global -->
    <div *ngIf="isLoadingDemande || isLoadingLignes" class="text-center mb-4">
      <div class="spinner-border spinner-border-lg text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-2 text-muted">Chargement des données...</p>
    </div>

    <!-- Section Articles déjà demandés -->
    <div class="card mb-4" *ngIf="!isLoadingDemande">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0">
          <i class="fa fa-check-circle"></i> Articles déjà demandés
          <span class="badge ml-2 px-3 py-2"
                style="background: linear-gradient(90deg, #20c997 0%, #17a2b8 100%); color: white; border-radius: 20px; font-size: 0.9rem; font-weight: 500;">
            {{ lignesExistantes.length }}
          </span>
        </h4>
      </div>
      <div class="card-body p-2">
        <div class="table-responsive">
          <table class="table table-sm table-striped mb-0">
            <thead class="thead-light">
            <tr>
              <th>Référence</th>
              <th>Désignation</th>
              <th>Quantité</th>
              <th>Unité</th>
              <th class="text-center" *ngIf="canModifyDemande">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let ligne of lignesExistantes; trackBy: trackByLigneId">
              <td class="font-weight-bold text-success">
                {{ ligne.ref || ligne.referenceArticle || 'N/A' }}
              </td>
              <td>{{ ligne.designation || ligne.designationArticle || 'N/A' }}</td>
              <td>
                <!-- Affichage normal -->
                <div *ngIf="!isLigneEditing(ligne)">
                  <span class="badge badge-success">
                    {{ ligne.qte || ligne.quantite || 0 }}
                  </span>
                </div>

                <!-- Mode édition -->
                <div *ngIf="isLigneEditing(ligne)">
                  <input type="number"
                         min="1"
                         class="form-control form-control-sm"
                         style="width: 80px;"
                         [(ngModel)]="ligneQuantities[getLigneKey(ligne)]"
                         (keyup.enter)="validateLigneQuantite(ligne)"
                         (blur)="validateLigneQuantite(ligne)">
                </div>
              </td>
              <td>{{ ligne.unite || 'N/A' }}</td>

              <td class="text-center" *ngIf="canModifyDemande">
                <div class="btn-group" role="group">
                  <!-- État normal : boutons modifier + supprimer -->
                  <ng-container *ngIf="!isLigneEditing(ligne)">
                    <button class="btn btn-sm btn-outline-primary"
                            (click)="startEditLigneQuantite(ligne)"
                            title="Modifier la quantité">
                      <i class="fa fa-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger"
                            (click)="deleteLigne(ligne)"
                            title="Supprimer cette ligne">
                      <i class="fa fa-trash"></i>
                    </button>
                  </ng-container>

                  <!-- État d'édition : boutons valider + annuler -->
                  <ng-container *ngIf="isLigneEditing(ligne)">
                    <button class="btn btn-sm btn-outline-success"
                            (click)="validateLigneQuantite(ligne)"
                            [disabled]="!isLigneQuantityValid(ligne)"
                            title="Valider la modification">
                      <i class="fa fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary"
                            (click)="cancelEditLigne(ligne)"
                            title="Annuler la modification">
                      <i class="fa fa-times"></i>
                    </button>
                  </ng-container>
                </div>
              </td>
            </tr>

            <!-- Message si aucune ligne -->
            <tr *ngIf="lignesExistantes.length === 0">
              <td [attr.colspan]="canModifyDemande ? 5 : 4" class="text-center text-muted py-4">
                <i class="fa fa-info-circle"></i>
                Aucune ligne de demande trouvée
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Section Articles disponibles avec pagination -->
    <div class="row" *ngIf="canModifyDemande">
      <div class="col-lg-12 mb-4">
        <div class="card h-100">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h4 class="mb-0 text-primary">
              <i class="fa fa-cubes"></i> Articles Disponibles
              <!-- Indicateur de chargement des articles -->
              <span *ngIf="isLoadingArticles" class="ml-2">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <small class="text-muted ml-1">Chargement...</small>
              </span>
              <!-- Informations de pagination -->
              <span *ngIf="!isLoadingArticles && totalElements > 0" class="badge badge-info ml-2">
                {{ articles.length }} / {{ totalElements }} articles
              </span>
            </h4>
          </div>

          <div class="card-body p-3">
            <!-- Contenu principal -->
            <div *ngIf="!isLoadingArticles">

              <!-- Section de recherche et filtres -->
              <div class="row mb-3">
                <!-- Recherche générale -->
                <div class="col-md-6">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="fa fa-search"></i>
                      </span>
                    </div>
                    <input type="text"
                           class="form-control"
                           placeholder="Rechercher par référence ou désignation..."
                           [(ngModel)]="searchTerm"
                           (input)="onSearchTermChange()">
                    <div class="input-group-append" *ngIf="searchTerm">
                      <button class="btn btn-outline-secondary"
                              (click)="clearSearch()"
                              title="Effacer la recherche">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Recherche par famille -->
                <div class="col-md-6">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="fa fa-sitemap"></i>
                      </span>
                    </div>

                    <ng-select class="custom-width"
                               placeholder="Sélectionnez une famille"
                               [(ngModel)]="selectedFamilleCode"
                               [clearable]="true"
                               [searchable]="true"
                               [disabled]="isLoadingFamilles"
                               (clear)="clearSearch()"
                               (change)="onFamilleSearch()"
                               name="famille">
                      <ng-option *ngFor="let item of familleOptions" [value]="item.code">
                        {{item.designation}}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
              </div>

              <!-- Indicateur des filtres actifs -->
              <div class="alert alert-info mb-3" *ngIf="searchTerm || selectedFamilleCode">
                <i class="fa fa-filter"></i>
                <strong>Filtres actifs :</strong>

                <span class="badge badge-primary ml-2" *ngIf="searchTerm">
                  <i class="fa fa-search"></i> "{{ searchTerm }}"
                  <button class="btn btn-sm btn-link text-white p-0 ml-1"
                          (click)="searchTerm = ''; loadArticlesPaginated()">
                    <i class="fa fa-times"></i>
                  </button>
                </span>

                <span class="badge badge-info ml-2" *ngIf="selectedFamilleCode">
                  <i class="fa fa-sitemap"></i> {{ getSelectedFamilleDesignation() }}
                  <button class="btn btn-sm btn-link text-white p-0 ml-1"
                          (click)="selectedFamilleCode = ''; loadArticlesPaginated()">
                    <i class="fa fa-times"></i>
                  </button>
                </span>

                <button class="btn btn-sm btn-outline-secondary ml-2"
                        (click)="clearSearch()">
                  <i class="fa fa-times"></i> Tout effacer
                </button>
              </div>

              <!-- Message si aucun article -->
              <div *ngIf="totalElements === 0" class="alert alert-warning">
                <i class="fa fa-exclamation-triangle"></i>
                Aucun article disponible. Vérifiez la connexion à la base de données.
              </div>

              <!-- Table des articles -->
              <div *ngIf="totalElements > 0">
                <!-- Info pagination en haut -->
                <div class="mb-2">
                  <small class="text-muted">
                    Page {{ currentPage + 1 }} sur {{ totalPages }}
                    ({{ totalElements }} article(s) au total)
                    <span *ngIf="searchTerm || selectedFamilleCode"> - Résultats filtrés</span>
                  </small>
                </div>

                <!-- Table scrollable -->
                <div style="max-height: 400px; overflow-y: auto;" class="border rounded">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="thead-light sticky-top">
                    <tr>
                      <th style="width: 15%"
                          class="cursor-pointer"
                          (click)="changeSorting('ref')">
                        Référence
                        <i class="fa fa-sort ml-1"
                           [ngClass]="{
                             'fa-sort-up': sortBy === 'ref' && sortDir === 'asc',
                             'fa-sort-down': sortBy === 'ref' && sortDir === 'desc'
                           }"></i>
                      </th>
                      <th style="width: 35%"
                          class="cursor-pointer"
                          (click)="changeSorting('designation')">
                        Désignation
                        <i class="fa fa-sort ml-1"
                           [ngClass]="{
                             'fa-sort-up': sortBy === 'designation' && sortDir === 'asc',
                             'fa-sort-down': sortBy === 'designation' && sortDir === 'desc'
                           }"></i>
                      </th>
                      <th style="width: 10%"
                          class="cursor-pointer"
                          (click)="changeSorting('unite')">
                        Unité
                        <i class="fa fa-sort ml-1"
                           [ngClass]="{
                             'fa-sort-up': sortBy === 'unite' && sortDir === 'asc',
                             'fa-sort-down': sortBy === 'unite' && sortDir === 'desc'
                           }"></i>
                      </th>
                      <th style="width: 15%">Famille Statistique</th>
                      <th style="width: 10%" class="text-center">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let article of articles; trackBy: trackByArticleId"
                        class="cursor-pointer"
                        [ngClass]="{'table-warning': isArticleUsed(article)}">
                      <td class="font-weight-bold">
                        {{ article.reference }}
                      </td>
                      <td>
                        <strong>{{ article.designation }}</strong>
                      </td>
                      <td>
                        <span class="text-muted">{{ article.unite }}</span>
                      </td>
                      <td>
                        <small class="text-info">{{ article.familleStatistique1 || '-' }}</small>
                      </td>

                      <td class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                          <!-- Article déjà utilisé -->
                          <div *ngIf="isArticleUsed(article)">
                            <span class="badge badge-warning">
                              <i class="fa fa-check"></i> Ajouté
                            </span>
                          </div>

                          <!-- État normal : bouton + -->
                          <div *ngIf="!isArticleUsed(article) && !isEditing(article.id!)">
                            <button class="btn btn-sm btn-outline-primary rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;"
                                    (click)="startEditQuantity(article.id!)"
                                    title="Ajouter l'article">
                              <i class="fa fa-plus" style="font-size: 16px;"></i>
                            </button>
                          </div>

                          <!-- État d'édition : input + boutons -->
                          <div *ngIf="!isArticleUsed(article) && isEditing(article.id!)"
                               class="d-flex align-items-center">
                            <input type="number"
                                   min="1"
                                   class="form-control form-control-sm mr-2"
                                   style="width: 70px;"
                                   placeholder="Qté"
                                   [(ngModel)]="articleQuantities[article.id!]"
                                   (keyup.enter)="validateQuantity(article)"
                                   (blur)="validateQuantity(article)">

                            <button class="btn btn-sm btn-outline-success rounded-circle d-flex align-items-center justify-content-center mr-1"
                                    style="width: 32px; height: 32px;"
                                    (click)="validateQuantity(article)"
                                    [disabled]="!isQuantityValid(article.id!)"
                                    title="Valider l'article">
                              <i class="fa fa-check" style="font-size: 14px;"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 32px; height: 32px;"
                                    (click)="cancelEdit(article.id!)"
                                    title="Annuler">
                              <i class="fa fa-times" style="font-size: 14px;"></i>
                            </button>
                          </div>
                        </div>
                      </td>
                    </tr>

                    <!-- Message si aucun article sur cette page -->
                    <tr *ngIf="articles.length === 0">
                      <td colspan="5" class="text-center text-muted py-4">
                        <i class="fa fa-info-circle"></i>
                        <span *ngIf="searchTerm || selectedFamilleCode">
                          Aucun article trouvé pour les critères sélectionnés
                        </span>
                        <span *ngIf="!searchTerm && !selectedFamilleCode">
                          Aucun article disponible sur cette page
                        </span>
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </div>

                <!-- ✅ NOUVELLE PAGINATION : Une seule ligne avec 3 sections -->
                <div class="row align-items-center mt-3" *ngIf="totalPages > 1">

                  <!-- 📍 GAUCHE : Sélecteur de taille de page -->
                  <div class="col-md-3">
                    <div class="d-flex align-items-center">
                      <label class="mb-0 mr-2" style="white-space: nowrap;">Afficher</label>
                      <select class="form-control form-control-sm"
                              style="width: 70px;"
                              [(ngModel)]="pageSize"
                              (change)="changePageSize(pageSize)">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                      </select>
                      <span class="ml-2 text-muted" style="white-space: nowrap;">articles par page</span>
                    </div>
                  </div>

                  <!-- 🎯 CENTRE : Boutons de pagination -->
                  <div class="col-md-6 d-flex justify-content-center">
                    <nav aria-label="Pagination des articles">
                      <ul class="pagination pagination-sm mb-0">
                        <!-- Première page -->
                        <li class="page-item" [class.disabled]="isFirstPage">
                          <button class="page-link" (click)="goToPage(0)" [disabled]="isFirstPage">
                            <i class="fa fa-angle-double-left"></i>
                          </button>
                        </li>

                        <!-- Page précédente -->
                        <li class="page-item" [class.disabled]="isFirstPage">
                          <button class="page-link" (click)="previousPage()" [disabled]="isFirstPage">
                            <i class="fa fa-angle-left"></i>
                          </button>
                        </li>

                        <!-- Numéros de pages -->
                        <li class="page-item"
                            *ngFor="let page of getPageNumbers()"
                            [class.active]="page === currentPage">
                          <button class="page-link" (click)="goToPage(page)">
                            {{ page + 1 }}
                          </button>
                        </li>

                        <!-- Page suivante -->
                        <li class="page-item" [class.disabled]="isLastPage">
                          <button class="page-link" (click)="nextPage()" [disabled]="isLastPage">
                            <i class="fa fa-angle-right"></i>
                          </button>
                        </li>

                        <!-- Dernière page -->
                        <li class="page-item" [class.disabled]="isLastPage">
                          <button class="page-link" (click)="goToPage(totalPages - 1)" [disabled]="isLastPage">
                            <i class="fa fa-angle-double-right"></i>
                          </button>
                        </li>
                      </ul>
                    </nav>
                  </div>

                  <!-- 📍 DROITE : Affichage de la plage -->
                  <div class="col-md-3 text-right">
                    <small class="text-muted">
                      Affichage {{ (currentPage * pageSize) + 1 }} à
                      {{ Math.min((currentPage + 1) * pageSize, totalElements) }}
                      sur {{ totalElements }} articles
                    </small>
                  </div>

                </div>
              </div>
            </div>

            <!-- Chargement des articles -->
            <div *ngIf="isLoadingArticles" class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-muted">Chargement des articles...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message si demande non modifiable -->
    <div class="alert alert-info" *ngIf="!canModifyDemande && !isLoadingDemande">
      <i class="fa fa-info-circle"></i>
      Cette demande ne peut plus être modifiée car elle a déjà été envoyée.
    </div>

    <!-- Boutons d'action -->
    <div class="d-flex justify-content-between align-items-center mt-4">
      <button routerLink="/demandes-achat"
              type="button"
              class="btn btn-secondary">
        <i class="fa fa-arrow-left"></i> Retour aux Demandes
      </button>

      <div *ngIf="canModifyDemande && lignesExistantes.length > 0">
        <button class="btn btn-success"
                (click)="updateDemandeAchatStatut()"
                title="Envoyer la demande">
          <i class="fa fa-paper-plane"></i> Envoyer la demande
        </button>
      </div>
    </div>
  </div>
</div>
