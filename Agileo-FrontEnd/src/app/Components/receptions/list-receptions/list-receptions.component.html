<!-- list-receptions.component.html - VERSION HARMONISÉE AVEC DEMANDES D'ACHAT - CORRIGÉE -->

<div class="row mx-1">
  <div class="col-md-12">
    <div class="card" [ngClass]="{'collapsed': isCollapsed, 'fullscreen': isFullscreen}">
      <div class="card-header">
        <h3 class="card-title">Liste des réceptions</h3>
        <!-- Affichage du rôle utilisateur pour info -->
        <div class="card-options d-flex align-items-center">
          <a class="card-options-collapse text-blue" (click)="toggleCollapse()">
            <i class="fe" [ngClass]="{'fe-chevron-up': !isCollapsed, 'fe-chevron-down': isCollapsed}"></i>
          </a>
          <a class="card-options-fullscreen text-blue" (click)="toggleFullscreen()">
            <i class="fe" [ngClass]="{'fe-maximize': !isFullscreen, 'fe-minimize': isFullscreen}"></i>
          </a>
        </div>
      </div>

      <div class="card-body">
        <!-- Message de chargement utilisateur -->
        <div *ngIf="isLoadingUser" class="text-center py-3">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="sr-only">Chargement des permissions...</span>
          </div>
          <small class="d-block mt-2">Vérification des permissions...</small>
        </div>

        <!-- Contenu principal -->
        <div *ngIf="!isLoadingUser">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
            <div class="d-flex align-items-center gap-2 flex-nowrap">
              <div class="input-group border rounded-pill px-3 py-2 mr-2" style="min-width: 290px;">
                    <span style="font-size: 20px; margin-right: 5px;">
      <i class="fa fa-search"></i>
    </span>
                <input type="text"
                       class="form-control border-0 p-0"
                       placeholder="Chercher réception par ..."
                       style="box-shadow: none; outline: none;"
                       [(ngModel)]="pfiltre"
                       (ngModelChange)="onSearchChange()">
              </div>
            </div>

            <!-- Bouton d'ajout avec vérification des permissions -->
            <div class="btn-group">
              <button *ngIf="canCreateReceptions()" type="button" class="btn btn-success">Options</button>
              <button *ngIf="canCreateReceptions()" type="button" class="btn btn-success dropdown-toggle"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <ul *ngIf="canCreateReceptions()" class="dropdown-menu dropdown-menu-right mt-1">
                <li style="min-width: 250px">
                  <a type="button" (click)="ouvrirModalAvecDelay()" class="pl-3 py-1">
                    <i class="fa fa-truck text-success"></i> Ajouter une réception
                  </a>
                </li>
              </ul>

              <!-- Message si pas de permissions -->
              <div *ngIf="!canCreateReceptions()" class="text-muted">
                <small><i class="fa fa-lock"></i> Création non autorisée</small>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped mb-0 text-nowrap">
              <thead>
              <tr>
                <th>ID
                  <button class="btn-tri-transparent" (click)="sortColumn('numero')"><i class="fa"
                                                                                        [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'numero' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'numero' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
                <th>BC
                  <button class="btn-tri-transparent" (click)="sortColumn('commande')"><i class="fa"
                                                                                          [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'commande' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'commande' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
                <th>Affaire
                  <button class="btn-tri-transparent" (click)="sortColumn('commande')"><i class="fa"
                                                                                          [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'commande' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'commande' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
                <th>Date de réception
                  <button class="btn-tri-transparent" (click)="sortColumn('sysCreationDate')"><i class="fa"
                                                                                                 [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'sysCreationDate' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'sysCreationDate' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
         <!--       <th>Créé par
                  <button class="btn-tri-transparent" (click)="sortColumn('sysUserId')"><i class="fa"
                                                                                           [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'sysUserId' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'sysUserId' && sort.direction === 'desc'
                     }" ></i></button>
                </th>-->


                <th>N° BL
                  <button class="btn-tri-transparent" (click)="sortColumn('referenceBl')"><i class="fa"
                                                                                           [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'referenceBl' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'referenceBl' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
                <th>DATE BL
                  <button class="btn-tri-transparent" (click)="sortColumn('dateBl')"><i class="fa"
                                                                                           [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'dateBl' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'dateBl' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
                <th>Status
                  <button class="btn-tri-transparent" (click)="sortColumn('sysState')"><i class="fa"
                                                                                          [ngClass]="{'fa-sort-alpha-asc' : sort.field !== 'sysState' || sort.direction === 'asc',
                    'fa-sort-alpha-desc': sort.field === 'sysState' && sort.direction === 'desc'
                     }" ></i></button>
                </th>
                <th>Action</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let reception of listReceptions | paginate:{ itemsPerPage: tableSize, currentPage: page, totalItems: count }">
                <td>
                  <!-- Lien vers détails seulement pour statut "Envoyé" -->
                  <a *ngIf="reception.statut === 'Envoyé'"
                     (click)="ouvrirModalDetails(reception)"
                     class="id-link cursor-pointer"
                     title="Voir les détails">
                    {{reception.id}}
                  </a>
                  <!-- Lien vers lignes seulement si l'utilisateur a les permissions -->
                  <a *ngIf="reception.statut !== 'Envoyé' && canModifyReceptions()"
                     [routerLink]="['/receptions', reception.id, 'add-ligne-reception']"
                     class="id-link"
                     title="Gérer les lignes de réception">
                    {{reception.id}}
                  </a>
                  <!-- Affichage simple pour consulteurs sans accès reception -->
                  <span *ngIf="reception.statut !== 'Envoyé' && !canModifyReceptions()"
                        class="text-muted"
                        title="Accès aux lignes non autorisé">
                    {{reception.id}}
                    <i class="fa fa-lock text-warning ml-1"></i>
                  </span>
                </td>
                <td>{{reception.affaireId}}</td>
                <td>
                  <strong>{{reception.affaireCode}}</strong> <br>
                  <small class="text-muted" *ngIf="reception.affaireLibelle">{{reception.affaireLibelle}}</small>
                </td>
                <td>{{reception.dateReception | date:'dd/MM/yyyy'}}</td>
            <!--    <td>
                  <span class="badge badge-secondary">{{reception.userLogin}}</span>
                  &lt;!&ndash; Indicateur si c'est la réception de l'utilisateur actuel &ndash;&gt;
                  <i *ngIf="reception.userLogin === currentUser?.login"
                     class="fa fa-user text-primary ml-1" title="Votre réception"></i>
                </td>-->
                <td>{{reception.referenceBl}}</td>
                <td>{{reception.dateBl | date:'dd/MM/yyyy'}}</td>
                <td>
  <span class="badge"
        [ngClass]="(reception.statut === 'Envoyé' && reception.blDivalto != null && reception.blDivalto !== -1) ? 'badge-success' :
                   reception.statut === 'Envoyé' ? 'badge-warning' :
                   reception.statut === 'Brouillon' ? 'badge-secondary' : 'badge-success'">
    {{(reception.statut === 'Envoyé' && reception.blDivalto != null && reception.blDivalto !== -1) ? 'Reçu' : (reception.statut || 'Brouillon')}}
  </span>
                </td>
                <td>
                  <div class="btn-group">
                    <button type="button"
                            class="btn btn-outline-primary btn-sm"
                            (click)="ouvrirModalDetails(reception)"
                            title="Voir les détails">
                      <i class="fa fa-eye" aria-hidden="true"></i>
                    </button>

                    <!-- Bouton d'envoi seulement si l'utilisateur a les permissions -->
                    <button *ngIf="reception.statut !== 'Envoyé' && canSendReceptions()"
                            type="button"
                            class="btn btn-outline-success btn-sm ml-1"
                            (click)="changerStatutReception(reception, 'Envoyé')"
                            title="Envoyer la réception">
                      <i class="fa fa-paper-plane" aria-hidden="true"></i>
                    </button>

                    <button *ngIf="reception.statut !== 'Envoyé' && canModifyReceptions()"
                            type="button"
                            class="btn btn-outline-warning btn-sm ml-1"
                            (click)="ouvrirModalUpdateAvecDelay(reception)"
                            title="Modifier la réception">
                      <i class="fa fa-pencil" aria-hidden="true"></i>
                    </button>
                    <button *ngIf="reception.statut !== 'Envoyé' && canDeleteReceptions()"
                            type="button"
                            class="btn btn-outline-danger btn-sm ml-1"
                            (click)="deleteReception(reception)"
                            title="Supprimer la réception">
                      <i class="fa fa-trash" aria-hidden="true"></i>
                    </button>
                    <!-- Icône de statut pour utilisateurs sans permissions d'envoi -->
                    <span *ngIf="reception.statut !== 'Envoyé' && !canSendReceptions()"
                          class="btn btn-outline-secondary btn-sm ml-1 disabled"
                          title="Envoi non autorisé pour votre rôle">
                      <i class="fa fa-lock" aria-hidden="true"></i>
                    </span>
                  </div>
                </td>
              </tr>

              <!-- Message si aucune réception -->
              <tr *ngIf="listReceptions && listReceptions.length === 0 && !isLoading">
                <td colspan="8" class="text-center py-4">
                  <div class="text-muted">
                    <i class="fa fa-search fa-2x mb-2"></i>
                    <p *ngIf="pfiltre && pfiltre.trim() !== ''">
                      Aucune réception trouvée pour "<strong>{{ pfiltre }}</strong>"
                    </p>
                    <p *ngIf="!pfiltre || pfiltre.trim() === ''">
                      Aucune réception trouvée
                    </p>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>

            <div class="mt-3 d-flex justify-content-center">
              <pagination-controls
                previousLabel="Précédent"
                nextLabel="Suivant"
                (pageChange)="onTableDataChange($event)">
              </pagination-controls>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Boutons masqués pour déclencher les modals -->
  <button #btnFake class="d-none" data-toggle="modal" data-target="#addModal"></button>
  <button #btnFake class="d-none" data-toggle="modal" data-target="#updateModal"></button>
  <button #btnFake class="d-none" data-toggle="modal" data-target="#deleteModal"></button>
  <button #btnFake class="d-none" data-toggle="modal" data-target="#detailsModal"></button>
</div>

<!------------------------Modal Ajout Réception ----------------------------->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-hidden="true" *ngIf="canCreateReceptions()">
  <app-add-reception
    (ajoutEffectue)="loadReceptions()"
    *ngIf="showModal"
  ></app-add-reception>
</div>

<!------------------------Modal Détails Réception ----------------------------->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h4 class="modal-title" id="detailsModalLabel">
          <i class="fa fa-info-circle"></i>
          Détails de la Réception #{{selectedReception?.id}}
        </h4>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body" *ngIf="selectedReception">
        <!-- Informations générales -->
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fa fa-info"></i> Informations Générales</h5>
              </div>
              <div class="card-body">
                <div class="row mb-1">
                  <div class="col-md-12">
                    <h5 class="text-muted mb-1">Affaire/Chantier</h5>
                    <span class="badge badge-info">{{selectedReception?.affaireCode}} - {{selectedReception?.affaireLibelle}}</span>

                  </div>

                </div>




                <div class="row mb-1">
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Date de réception</h5>
                    <p>{{selectedReception?.dateReception | date:'dd/MM/yyyy '}}</p>
                  </div>
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Créé par:</h5>
                    <p>{{selectedReception?.userLogin}}
                      <span *ngIf="selectedReception?.userLogin === currentUser?.login?.toString()" class="badge badge-primary ml-2">Vous</span>
                    </p>

                  </div>

                </div>
                <div class="row mb-1">
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">N°BL:</h5>
                    <p> {{selectedReception?.referenceBl}}</p>
                  </div>
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Date BL:</h5>
                    <p>{{selectedReception?.dateBl | date:'dd/MM/yyyy '}}</p>
                  </div>
                </div>
                <div class="row mb-1">
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Réf. Fournisseur:</h5>
                    <p> {{selectedReception?.refFournisseur}}</p>
                  </div>
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Nom Fournisseur:</h5>
                    <p>   {{selectedReception?.nomFournisseur || 'Non spécifié'}}</p>
                  </div>

                </div>
                <div class="row mb-1">
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Référence BC:</h5>
                    <p> {{selectedReception?.affaireId}}</p>
                  </div>

                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Statut</h5>
                    <span class="badge"
                          [ngClass]="selectedReception?.statut === 'Envoyé' ? 'badge-warning' : selectedReception?.statut === 'Brouillon' ? 'badge-secondary' : 'badge-primary'">
                {{selectedReception?.statut || 'En cours'}}
              </span>
                  </div>
                </div>
                <div class="row mb-1">
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">Id Agelio:</h5>
                    <p>{{selectedReception?.id}}</p>
                  </div>
                  <div class="col-md-6">
                    <h5 class="text-muted mb-1">ID Divalto:</h5>
                    <p>{{selectedReception?.blDivalto > 0 ? selectedReception?.blDivalto : '-'}}</p>
                  </div>
                </div>

              </div>
            </div>
          </div>


        </div>

        <!-- Lignes de réception -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="fa fa-list"></i>
              Articles Reçus
              <span class="badge badge-light text-dark ml-2" *ngIf="lignesReception">
                {{lignesReception.length}} article(s)
              </span>
              <span class="badge badge-primary ml-2">Accès reception</span>
            </h5>
          </div>
          <div class="card-body">
            <!-- Chargement des lignes -->
            <div *ngIf="loadingLignes" class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Chargement...</span>
              </div>
              <p class="mt-2 text-muted">Chargement des articles...</p>
            </div>

            <!-- Table des lignes si présentes -->
            <div *ngIf="lignesReception && lignesReception.length > 0 && !loadingLignes" class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead class="thead-light">
                <tr>
                  <th>Référence</th>
                  <th>Désignation Article</th>
                  <th class="text-center">Quantité Reçue</th>
                  <th>Unité</th>
                  <th>Famille 1</th>
                  <th>Famille 2</th>
                  <th>Famille 3</th>
                  <th>Famille 4</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let ligne of lignesReception">
                  <td class="font-weight-bold text-primary">
                    <i class="fa fa-barcode"></i> {{ligne.referenceArticle}}
                  </td>
                  <td>
                    <i class="fa fa-cube text-muted"></i>
                    {{ligne.designationArticle}}
                  </td>
                  <td class="text-center">
                    <span class="badge badge-success badge-lg">
                      {{ligne.quantite}}
                    </span>
                  </td>
                  <td>
                    <span class="text-info">{{ligne.unite}}</span>
                  </td>
                  <td>
                    <small class="text-muted">{{ligne.familleStatistique1 || '-'}}</small>
                  </td>
                  <td>
                    <small class="text-muted">{{ligne.familleStatistique2 || '-'}}</small>
                  </td>
                  <td>
                    <small class="text-muted">{{ligne.familleStatistique3 || '-'}}</small>
                  </td>
                  <td>
                    <small class="text-muted">{{ligne.familleStatistique4 || '-'}}</small>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

            <!-- Message si aucune ligne -->
            <div *ngIf="lignesReception && lignesReception.length === 0 && !loadingLignes" class="alert alert-info text-center">
              <i class="fa fa-info-circle fa-2x mb-2"></i>
              <h6>Aucun article reçu</h6>
              <p class="mb-0 text-muted">Cette réception ne contient aucun article pour le moment.</p>
            </div>

            <!-- Message d'erreur -->
            <div *ngIf="errorLignes" class="alert alert-warning text-center">
              <i class="fa fa-exclamation-triangle fa-2x mb-2"></i>
              <h6>Erreur de chargement</h6>
              <p class="mb-0">Impossible de charger les articles de cette réception.</p>
              <button class="btn btn-sm btn-outline-warning mt-2" (click)="loadLignesReception(selectedReception!.id!)">
                <i class="fa fa-refresh"></i> Réessayer
              </button>
            </div>
          </div>
        </div>

        <!-- Fichiers joints -->
        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fa fa-file"></i> Fichiers Joints
              <!-- NOUVEAU : Bouton de rafraîchissement manuel -->
              <button type="button"
                      class="btn btn-sm btn-outline-primary ml-2"
                      (click)="refreshDetailsFiles()"
                      title="Actualiser les fichiers">
                <i class="fa fa-refresh"></i>
                Actualiser
              </button>
            </h5>
          </div>
          <div class="card-body">
            <!-- MODIFICATION PRINCIPALE : Ajouter la référence template #detailsFilesComponent -->
            <app-details-files-reception
              #detailsFilesComponent
              [receptionId]="selectedReception.id!">
            </app-details-files-reception>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="d-flex justify-content-between w-100">
          <div class="text-muted small"></div>

          <!-- Actions -->
          <div>
            <!-- Bouton pour aller aux lignes -->
            <a *ngIf="selectedReception?.statut !== 'Envoyé' && canModifyReceptions()"
               [routerLink]="['/receptions', selectedReception?.id, 'add-ligne-reception']"
               class="btn btn-outline-primary mr-2"
               data-dismiss="modal">
              <i class="fa fa-edit"></i>
              Gérer les articles
            </a>

            <!-- Bouton d'envoi -->
            <button *ngIf="selectedReception?.statut !== 'Envoyé' && canSendReceptions()"
                    type="button"
                    class="btn btn-success mr-2"
                    (click)="changerStatutReception(selectedReception!, 'Envoyé')">
              <i class="fa fa-paper-plane"></i>
              Envoyer la Réception
            </button>

            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation d'envoi -->
<div class="modal fade" id="confirmSendModal" tabindex="-1" role="dialog" aria-labelledby="confirmSendModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmSendModalLabel">
          <i class="fe fe-alert-triangle mr-2"></i>
          Action critique
        </h5>
        <button type="button" class="close text-white" (click)="annulerEnvoi()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="fe fe-alert-octagon text-danger mr-3" style="font-size: 24px;"></i>
          <div>
            <p class="mb-1">Voulez-vous vraiment envoyer cette demande ?</p>
            <small class="text-muted">Cette action est <strong>irréversible</strong>.
              Une fois envoyée, la récéption ne pourra plus être modifiée.</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="annulerEnvoi()">
          Annuler
        </button>
        <button type="button" class="btn btn-danger" (click)="envoyerDemandeConfirmed()">
          <i class="fe fe-send mr-1"></i>Confirmer l'envoi
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteModalLabel">
          <i class="fe fe-alert-triangle mr-2"></i>
          Action critique
        </h5>
        <button type="button" class="close text-white" (click)="annulerSuppression()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="fe fe-alert-octagon text-danger mr-3" style="font-size: 24px;"></i>
          <div>
            <p class="mb-1">Voulez-vous vraiment supprimer cette demande ?</p>
            <small class="text-muted">Cette action est <strong>irréversible</strong>.</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="annulerSuppression()">
          Annuler
        </button>
        <button type="button" class="btn btn-danger" (click)="suppressionDemandeConfirmed()">
          Confirmer la suppression
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Modification de Réception - VERSION HARMONISÉE AVEC DEMANDES D'ACHAT -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">

      <!-- Modal Header - COULEURS HARMONISÉES -->
      <div class="modal-header bg-warning text-white">
        <h4 class="modal-title" id="updateModalLabel">
          <i class="fa fa-edit"></i>
          Modifier la Réception #{{receptionToUpdate?.id}}
        </h4>
        <button type="button" class="close text-white" (click)="fermerModalUpdate()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Progress Stepper -->
      <div class="stepper-wrapper">
        <div class="stepper-item"
             [class.completed]="currentStepUpdate > 1"
             [class.active]="currentStepUpdate === 1"
             [class.disabled]="receptionHasLignes && currentStepUpdate !== 1">
          <div class="step-counter">
            <i class="fa" [ngClass]="receptionHasLignes ? 'fa-lock' : 'fa-shopping-cart'"></i>
          </div>
          <div class="step-name">Sélection</div>
        </div>

        <div class="stepper-item"
             [class.completed]="currentStepUpdate > 2"
             [class.active]="currentStepUpdate === 2"
             [class.disabled]="receptionHasLignes && currentStepUpdate !== 2">
          <div class="step-counter">
            <i class="fa" [ngClass]="receptionHasLignes ? 'fa-lock' : 'fa-file-text-o'"></i>
          </div>
          <div class="step-name">Détails BC</div>
        </div>

        <div class="stepper-item"
             [class.completed]="currentStepUpdate > 3"
             [class.active]="currentStepUpdate === 3">
          <div class="step-counter">
            <i class="fa fa-calendar"></i>
          </div>
          <div class="step-name">Réception</div>
        </div>

        <div class="stepper-item"
             [class.completed]="currentStepUpdate > 4"
             [class.active]="currentStepUpdate === 4">
          <div class="step-counter">
            <i class="fa fa-paperclip"></i>
          </div>
          <div class="step-name">Fichiers</div>
        </div>
      </div>


      <!-- Modal Body -->
      <div class="modal-body" *ngIf="receptionToUpdate">
        <form #updateForm="ngForm">

          <!-- Message d'information si la réception a des lignes -->
          <div *ngIf="receptionHasLignes" class="alert alert-warning mb-4">
            <i class="fa fa-lock"></i>
            <strong>Modification limitée :</strong>
            Cette réception contient déjà des articles. L'affaire, le fournisseur et le bon de commande ne peuvent plus être modifiés.
            Vous pouvez uniquement modifier la date du BL, le numéro BL et les pièces jointes.
          </div>

          <!-- ==================== STEP 1: SÉLECTION ==================== -->
          <div *ngIf="currentStepUpdate === 1" class="step-content">
            <h6 class="step-title">
              <i class="fa fa-filter"></i> Sélection du bon de commande
              <span *ngIf="receptionHasLignes" class="badge badge-warning ml-2">
                <i class="fa fa-lock"></i> Lecture seule
              </span>
            </h6>

            <!-- Message d'information -->
            <div *ngIf="receptionHasLignes" class="alert alert-info">
              <i class="fa fa-info-circle"></i>
              Ces informations ne peuvent pas être modifiées car la réception contient déjà des articles.
            </div>

            <!-- Sélection Affaire -->
            <div class="form-group">
              <label for="affaireFilterUpdate">
                Affaire <span class="text-danger">*</span>
              </label>
              <ng-select
                id="affaireFilterUpdate"
                [(ngModel)]="selectedAffaireUpdate"
                [items]="availableAffairesUpdate"
                bindLabel="name"
                bindValue="code"
                placeholder="Sélectionnez une affaire"
                [clearable]="true"
                (change)="onAffaireFilterChangeUpdate($event)"
                [disabled]="isLoadingUser || receptionHasLignes"
                [readonly]="receptionHasLignes"
                name="affaireFilterUpdate">
                <ng-template ng-option-tmp let-item="item">
                  <strong>{{item.code}}</strong> - {{item.name}}
                </ng-template>
              </ng-select>
              <small class="form-text text-muted" *ngIf="!receptionHasLignes">
                <i class="fa fa-info-circle"></i> Sélectionnez d'abord l'affaire
              </small>
              <small class="form-text text-warning" *ngIf="receptionHasLignes">
                <i class="fa fa-lock"></i> Modification désactivée (réception avec articles)
              </small>
            </div>

            <!-- Sélection Fournisseur -->
            <div class="form-group" *ngIf="availableFournisseursUpdate.length > 0">
              <label for="fournisseurFilterUpdate">
                Fournisseur <span class="text-muted">(optionnel)</span>
              </label>
              <ng-select
                id="fournisseurFilterUpdate"
                [(ngModel)]="selectedFournisseurUpdate"
                [items]="availableFournisseursUpdate"
                bindLabel="name"
                placeholder="Tous les fournisseurs"
                [clearable]="true"
                (change)="onFournisseurFilterChangeUpdate($event)"
                (clear)="onFournisseurClearUpdate()"
                [disabled]="receptionHasLignes"
                [readonly]="receptionHasLignes"
                name="fournisseurFilterUpdate">
                <ng-template ng-option-tmp let-item="item">
                  <strong>{{item.name}}</strong> <span class="text-muted">({{item.count}} commande(s))</span>
                </ng-template>
              </ng-select>
              <small class="form-text text-warning" *ngIf="receptionHasLignes">
                <i class="fa fa-lock"></i> Modification désactivée
              </small>
            </div>

            <!-- Sélection Bon de commande -->
            <div class="form-group">
              <label for="bonCommandeUpdate">
                Bon de commande <span class="text-danger">*</span>
              </label>
              <ng-select
                id="bonCommandeUpdate"
                [(ngModel)]="selectedBonCommande"
                [items]="filteredBonCommandesUpdate"
                bindLabel="commande"
                placeholder="Sélectionnez un bon de commande"
                [clearable]="false"
                (change)="onBonCommandeChangeUpdate($event)"
                [disabled]="!selectedAffaireUpdate || receptionHasLignes"
                [readonly]="receptionHasLignes"
                name="bonCommandeUpdate">
                <ng-template ng-option-tmp let-item="item">
                  <div class="bon-commande-option">
                    <div class="bc-numero"><strong>{{item.commande}}</strong></div>
                    <div class="bc-fournisseur text-muted">{{item.fournisseur}}</div>
                  </div>
                </ng-template>
              </ng-select>

              <small class="form-text text-warning" *ngIf="receptionHasLignes">
                <i class="fa fa-lock"></i> Modification désactivée (réception avec articles)
              </small>
            </div>
          </div>

          <!-- ==================== STEP 2: LIGNES DU BON DE COMMANDE ==================== -->
          <div *ngIf="currentStepUpdate === 2" class="step-content">
            <h6 class="step-title">
              <i class="fa fa-list"></i> Lignes du bon de commande
              <span *ngIf="receptionHasLignes" class="badge badge-info ml-2">
      <i class="fa fa-eye"></i> Consultation uniquement
    </span>
            </h6>

            <!-- Message si réception a des lignes -->
            <div *ngIf="receptionHasLignes" class="alert alert-info">
              <i class="fa fa-info-circle"></i>
              Vous consultez les informations du bon de commande en lecture seule.
            </div>

            <!-- Détails du bon de commande -->
            <div class="bc-details-card" *ngIf="selectedBonCommande">
              <div class="bc-header">
                <h5 class="bc-numero">
                  <i class="fa fa-shopping-cart text-primary"></i>
                  BC N° {{selectedBonCommande}}
                </h5>
                <div>
        <span class="badge badge-info mr-2">
          <i class="fa fa-briefcase"></i> {{receptionToUpdate?.affaireCode}}
        </span>
                  <span class="badge badge-secondary">
          <i class="fa fa-building"></i> {{receptionToUpdate?.nomFournisseur}}
        </span>
                </div>
              </div>

              <!-- Loading des lignes -->
              <div *ngIf="isLoadingLignesBCUpdate" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="sr-only">Chargement...</span>
                </div>
                <p class="text-muted mt-2">Chargement des lignes du bon de commande...</p>
              </div>

              <!-- Tableau des lignes -->
              <div *ngIf="!isLoadingLignesBCUpdate && lignesBonCommandeUpdate.length > 0" class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="thead-light">
                  <tr>
                    <th>Référence</th>
                    <th>Désignation</th>
                    <th class="text-center">Qté Commandée</th>
                    <th class="text-center">Qté Disponible</th>
                    <th>Unité</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let ligne of lignesBonCommandeUpdate">
                    <td class="font-weight-bold text-primary">{{ligne.reference || ligne.referenceArticle}}</td>
                    <td>{{ligne.designation || ligne.designationArticle}}</td>
                    <td class="text-center">
                      <span class="badge badge-info">{{ligne.quantite || ligne.quantiteCommandee}}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge badge-success">{{ligne.reste || ligne.quantiteDisponible}}</span>
                      <small class="text-muted d-block" *ngIf="ligne.qteLivre || ligne.quantiteDejaRecue">
                        Reçue: {{ligne.qteLivre || ligne.quantiteDejaRecue}}
                      </small>
                    </td>
                    <td>{{ligne.unite}}</td>
                  </tr>
                  </tbody>
                </table>
              </div>

              <!-- Message si aucune ligne -->
              <div *ngIf="!isLoadingLignesBCUpdate && lignesBonCommandeUpdate.length === 0" class="alert alert-warning text-center">
                <i class="fa fa-exclamation-triangle"></i>
                Aucune ligne trouvée pour ce bon de commande
              </div>
            </div>
          </div>

          <!-- ==================== STEP 3: INFORMATIONS DE RÉCEPTION ==================== -->
          <div *ngIf="currentStepUpdate === 3" class="step-content">
            <h6 class="step-title">
              <i class="fa fa-calendar"></i> Informations de réception
              <span *ngIf="receptionHasLignes" class="badge badge-success ml-2">
                <i class="fa fa-edit"></i> Modifiable
              </span>
            </h6>

            <!-- Récapitulatif sélection -->
            <div class="recap-box">
              <div class="recap-item">
                <strong>Affaire:</strong>
                <span>{{receptionToUpdate.affaireCode}} - {{receptionToUpdate.affaireLibelle}}</span>
                <span *ngIf="receptionHasLignes" class="badge badge-secondary ml-2">
                  <i class="fa fa-lock"></i> Verrouillé
                </span>
              </div>
              <div class="recap-item">
                <strong>Bon de commande:</strong>
                <span>{{selectedBonCommande || receptionToUpdate.affaireId}}</span>
                <span *ngIf="receptionHasLignes" class="badge badge-secondary ml-2">
                  <i class="fa fa-lock"></i> Verrouillé
                </span>
              </div>
              <div class="recap-item">
                <strong>Fournisseur:</strong>
                {{receptionToUpdate.nomFournisseur}}
                <span *ngIf="receptionHasLignes" class="badge badge-secondary ml-2">
                  <i class="fa fa-lock"></i> Verrouillé
                </span>
              </div>
            </div>

            <!-- Date Réception -->
            <div class="form-group">
              <label for="dateReceptionUpdate">
                Date BL <span class="text-danger">*</span>
                <span *ngIf="receptionHasLignes" class="badge badge-success ml-2">
                  <i class="fa fa-edit"></i> Modifiable
                </span>
              </label>
              <input
                type="date"
                class="form-control"
                id="dateReceptionUpdate"
                [(ngModel)]="receptionToUpdate.dateBl"
                name="dateReception"
                required>
              <small class="form-text text-success" *ngIf="receptionHasLignes">
                <i class="fa fa-check-circle"></i> Ce champ peut être modifié
              </small>
            </div>

            <!-- N° BL -->
            <div class="form-group">
              <label for="referenceBlUpdate">
                N° BL <span class="text-danger">*</span>
                <span *ngIf="receptionHasLignes" class="badge badge-success ml-2">
                  <i class="fa fa-edit"></i> Modifiable
                </span>
              </label>
              <input
                type="text"
                class="form-control"
                id="referenceBlUpdate"
                [(ngModel)]="receptionToUpdate.referenceBl"
                name="referenceBl"
                placeholder="Entrez le numéro BL">
              <small class="form-text text-success" *ngIf="receptionHasLignes">
                <i class="fa fa-check-circle"></i> Ce champ peut être modifié
              </small>
            </div>
          </div>

          <!-- ==================== STEP 4: FICHIERS ==================== -->
          <div *ngIf="currentStepUpdate === 4" class="step-content">
            <h6 class="step-title">
              <i class="fa fa-paperclip"></i> Fichiers joints <span class="text-muted">(optionnel)</span>
              <span *ngIf="receptionHasLignes" class="badge badge-success ml-2">
                <i class="fa fa-edit"></i> Modifiable
              </span>
            </h6>

            <!-- Message positif si la réception a des lignes -->
            <div *ngIf="receptionHasLignes && canModifyFiles()" class="alert alert-success mb-4">
              <i class="fa fa-check-circle"></i>
              <strong>Fichiers modifiables :</strong>
              Vous pouvez ajouter, modifier ou supprimer des pièces jointes même si cette réception contient des articles.
            </div>

            <!-- Zone d'upload si autorisation et place disponible -->
            <div *ngIf="canAddMoreFiles()" class="mb-4">
              <div class="upload-zone"
                   [class.drag-over]="isDragOver"
                   (click)="fileInput.click()"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onDrop($event)">

                <div class="text-center">
                  <i class="fa fa-cloud-upload fa-3x text-primary mb-3"></i>
                  <h5 class="mb-2">Ajouter des pièces jointes</h5>
                  <p class="text-muted mb-3">
                    Glissez-déposez vos fichiers ici ou cliquez pour sélectionner
                  </p>
                  <p class="small text-muted mb-0">
                    <strong>Formats autorisés :</strong> PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, JPEG<br>
                    <strong>Taille max :</strong> 50 MB par fichier
                  </p>
                </div>

                <input type="file"
                       #fileInput
                       (change)="onFileSelected($event)"
                       accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"
                       multiple
                       hidden>
              </div>

              <div class="text-center mt-2">
                <small class="text-info">
                  <i class="fa fa-info-circle"></i>
                  {{ getRemainingFilesCount() }} fichier(s) restant(s)
                </small>
              </div>
            </div>

            <!-- Message si limite atteinte -->
            <div *ngIf="!canAddMoreFiles() && canModifyFiles()" class="alert alert-warning text-center">
              <i class="fa fa-exclamation-triangle"></i>
              <strong>Limite atteinte</strong><br>
              Vous avez atteint la limite de 3 fichiers.
            </div>

            <!-- Message si modification interdite -->
            <div *ngIf="!canModifyFiles()" class="alert alert-danger text-center">
              <i class="fa fa-lock"></i>
              <strong>Modification interdite</strong><br>
              Les pièces jointes ne peuvent pas être modifiées car cette réception a été <strong>envoyée</strong>.
            </div>

            <!-- Chargement des fichiers -->
            <div *ngIf="loadingFiles" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Chargement des fichiers...</span>
              </div>
              <p class="mt-2 text-muted">Chargement en cours...</p>
            </div>

            <!-- Liste des nouveaux fichiers sélectionnés -->
            <div *ngIf="selectedFiles.length > 0 && !loadingFiles" class="mb-4">
              <h6 class="text-success mb-3">
                <i class="fa fa-plus-circle"></i>
                Fichiers à ajouter ({{ selectedFiles.length }})
              </h6>

              <div class="row">
                <div class="col-md-6 col-lg-4 mb-3" *ngFor="let file of selectedFiles; let i = index">
                  <div class="card border-success">
                    <div class="card-body p-3">
                      <h6 class="card-title text-truncate" [title]="file.name">
                        <i [class]="getFileIcon(file.name)"></i>
                        {{ file.name }}
                      </h6>

                      <div class="file-metadata">
                        <small class="text-muted d-block">
                          <i class="fa fa-weight"></i> {{ formatFileSize(file.size) }}
                        </small>
                        <span class="badge badge-success badge-sm">Nouveau</span>
                      </div>
                    </div>

                    <div class="card-footer p-2 bg-light">
                      <button type="button"
                              class="btn btn-outline-danger btn-sm btn-block"
                              (click)="removeSelectedFile(i)"
                              [disabled]="isUploading">
                        <i class="fa fa-trash"></i>
                        Retirer
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Liste des fichiers existants -->
            <div *ngIf="listPiecesJointes.length > 0 && !loadingFiles"
                 [class.mt-4]="selectedFiles.length > 0">
              <h6 class="text-primary mb-3">
                <i class="fa fa-file"></i>
                Fichiers existants ({{ listPiecesJointes.length }})

                <button type="button"
                        class="btn btn-sm btn-outline-primary ml-2"
                        (click)="refreshManuallyFilesList()"
                        [disabled]="loadingFiles || isUploading"
                        title="Actualiser la liste des fichiers">
                  <i class="fa fa-refresh" [class.fa-spin]="loadingFiles"></i>
                  Actualiser
                </button>
              </h6>

              <div class="row">
                <div class="col-md-6 col-lg-4 mb-3"
                     *ngFor="let file of listPiecesJointes; trackBy: trackByFileId">
                  <div class="card border-primary">
                    <div class="card-body p-3">
                      <h6 class="card-title text-truncate" [title]="file.fullFileName || file.name">
                        <i [class]="getFileIcon(file.fullFileName || file.name)"></i>
                        {{ file.fullFileName || file.name }}
                      </h6>

                      <div class="file-metadata">
                        <small class="text-muted d-block" *ngIf="file.size">
                          <i class="fa fa-weight"></i> {{ formatFileSize(file.size) }}
                        </small>
                        <span class="badge badge-primary badge-sm">Existant</span>
                      </div>
                    </div>

                    <div class="card-footer p-2 bg-light">
                      <div class="btn-group btn-group-sm w-100" role="group">
                        <button type="button"
                                class="btn btn-outline-success"
                                (click)="downloadFile(file)"
                                [disabled]="loadingFiles || isUploading"
                                title="Télécharger le fichier">
                          <i class="fa fa-download"></i>
                        </button>

                        <button type="button"
                                class="btn btn-outline-danger"
                                (click)="deleteFile(file.fileId)"
                                [disabled]="!canModifyFiles() || loadingFiles || isUploading"
                                *ngIf="canModifyFiles()"
                                title="Supprimer le fichier">
                          <i class="fa fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Message si aucun fichier -->
            <div *ngIf="listPiecesJointes.length === 0 && selectedFiles.length === 0 && !loadingFiles && !errorFiles"
                 class="text-center py-4">
              <i class="fa fa-file-o fa-3x text-muted mb-3"></i>
              <h6 class="text-muted">Aucune pièce jointe</h6>
              <p class="text-muted mb-0" *ngIf="canModifyFiles()">
                Ajoutez des fichiers pour documenter cette réception
              </p>
            </div>
          </div>

        </form>
      </div>

      <!-- Modal Footer - BOUTON HARMONISÉ -->
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                *ngIf="currentStepUpdate > 1 && (!receptionHasLignes || currentStepUpdate > 3)"
                (click)="previousStepUpdate()"
                [disabled]="isUploading || loadingFiles">
          <i class="fa fa-arrow-left"></i> Précédent
        </button>

        <button type="button"
                class="btn btn-secondary"
                (click)="fermerModalUpdate()"
                [disabled]="isUploading || loadingFiles">
          <i class="fa fa-times"></i> Annuler
        </button>

        <button type="button"
                class="btn btn-primary"
                *ngIf="currentStepUpdate < 4"
                (click)="nextStepUpdate()"
                [disabled]="!canGoToNextStepUpdate() || isUploading || loadingFiles">
          Suivant <i class="fa fa-arrow-right"></i>
        </button>

        <button type="button"
                class="btn btn-warning"
                *ngIf="currentStepUpdate === 4"
                (click)="updateReceptionInfo()"
                [disabled]="!updateForm.valid ||
                    (!selectedBonCommande && !receptionHasLignes) ||
                    !receptionToUpdate?.referenceBl ||
                    receptionToUpdate?.referenceBl.trim() === '' ||
                    isUploading ||
                    loadingFiles">
          <span *ngIf="isUploading || loadingFiles" class="spinner-border spinner-border-sm mr-1"></span>
          <i class="fa fa-save" *ngIf="!isUploading && !loadingFiles"></i>
          {{(isUploading || loadingFiles) ? 'Vérification...' : 'Enregistrer les modifications'}}
        </button>
      </div>

    </div>
  </div>
</div>
<!-- Styles CSS pour le système de fichiers -->
<style>
  .upload-zone {
    border: 2px dashed #007bff;
    border-radius: 8px;
    padding: 40px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
  }

  .upload-zone:hover {
    border-color: #0056b3;
    background-color: #e9ecef;
  }

  .upload-zone.drag-over {
    border-color: #28a745;
    background-color: #d4edda;
  }

  .file-metadata {
    margin-top: 8px;
  }

  .file-metadata .badge {
    margin-top: 4px;
  }

  .btn-group .btn {
    font-size: 12px;
  }

  .card-title {
    font-size: 14px;
    margin-bottom: 8px;
  }

  .card-footer .btn {
    font-size: 11px;
    padding: 4px 8px;
  }
</style>
