<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">
      <i class="fas fa-chart-line"></i>
      Tableau de bord
    </h1>
    <div class="dashboard-subtitle">
      <span *ngIf="isAdministrateur " class="badge badge-admin">Administrateur</span>
      <span *ngIf="!isAdministrateur " class="badge badge-user">Utilisateur</span>
      <span class="date">Aujourd'hui: {{ currentDate | date: 'dd/MM/yyyy' }}</span>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des statistiques...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && stats" class="dashboard-content">

    <!-- Stats Cards Row 1 - Vue d'ensemble -->
    <div class="stats-grid">
      <div class="stat-card stat-primary">
        <div class="stat-icon">
          <i class="fas fa-briefcase"></i>
        </div>
        <div class="stat-info">
          <h3>{{ stats.statistiquesGenerales.totalAffaires }}</h3>
          <p>Affaires actives</p>
        </div>
      </div>

      <div class="stat-card stat-success">
        <div class="stat-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-info">
          <h3>{{ stats.demandesAchat.total }}</h3>
          <p>Demandes d'achat</p>
          <span class="stat-badge" [ngClass]="stats.demandesAchat.evolutionPourcentage >= 0 ? 'positive' : 'negative'">
            <i [ngClass]="stats.demandesAchat.evolutionPourcentage >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
            {{ stats.demandesAchat.evolutionPourcentage }}%
          </span>
        </div>
      </div>

      <div class="stat-card stat-warning">
        <div class="stat-icon">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="stat-info">
          <h3>{{ stats.commandes.total }}</h3>
          <p>Commandes</p>
          <span class="stat-detail">{{ stats.commandes.dernierMois }} ce mois</span>
        </div>
      </div>

      <div class="stat-card stat-info">
        <div class="stat-icon">
          <i class="fas fa-box"></i>
        </div>
        <div class="stat-info">
          <h3>{{ stats.stock.articlesEnStock }}</h3>
          <p>Articles en stock</p>
          <span class="stat-detail">{{ stats.stock.articlesStockFaible }} en stock faible</span>
        </div>
      </div>
    </div>

    <!-- Stats Cards Row 2 - Détails -->
    <div class="stats-grid-secondary">
      <div class="stat-card-small">
        <div class="stat-small-content">
          <i class="fas fa-users"></i>
          <div>
            <h4>{{ stats.statistiquesGenerales.totalUtilisateurs }}</h4>
            <p>Utilisateurs</p>
          </div>
        </div>
      </div>

      <div class="stat-card-small">
        <div class="stat-small-content">
          <i class="fas fa-truck"></i>
          <div>
            <h4>{{ stats.statistiquesGenerales.totalFournisseurs }}</h4>
            <p>Fournisseurs</p>
          </div>
        </div>
      </div>

      <div class="stat-card-small">
        <div class="stat-small-content">
          <i class="fas fa-clipboard-list"></i>
          <div>
            <h4>{{ stats.consommations.total }}</h4>
            <p>Consommations</p>
          </div>
        </div>
      </div>

      <div class="stat-card-small">
        <div class="stat-small-content">
          <i class="fas fa-dolly"></i>
          <div>
            <h4>{{ stats.receptions.enAttente }}</h4>
            <p>Réceptions en attente</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
      <!-- Évolution Chart -->
      <div class="chart-card chart-large">
        <div class="chart-header">
          <h3><i class="fas fa-chart-area"></i> Évolution sur 30 jours</h3>
          <p>Suivi des demandes, consommations et réceptions</p>
        </div>
        <div class="chart-body">
          <canvas id="evolutionChart"></canvas>
        </div>
      </div>

      <!-- Demandes Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-chart-pie"></i> Statut des demandes</h3>
          <p>Répartition par état</p>
        </div>
        <div class="chart-body">
          <canvas id="demandesChart"></canvas>
        </div>
        <div class="chart-stats">
          <div class="chart-stat-item">
            <span class="label">Taux de validation</span>
            <span class="value">{{ stats.demandesAchat.tauxValidation }}%</span>
          </div>
        </div>
      </div>

      <!-- Stock Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-chart-bar"></i> État du stock</h3>
          <p>Disponibilité des articles</p>
        </div>
        <div class="chart-body">
          <canvas id="stockChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Articles populaires -->
    <div class="table-section">
      <div class="table-header">
        <h3><i class="fas fa-fire"></i> Articles les plus demandés</h3>
        <p>Top 10 des articles</p>
      </div>
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
          <tr>
            <th>Rang</th>
            <th>Référence</th>
            <th>Désignation</th>
            <th>Nb demandes</th>
            <th>Quantité totale</th>
            <th>Unité</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let article of stats.articlesPopulaires; let i = index">
            <td>
              <span class="rank-badge" [class.top-3]="i < 3">{{ i + 1 }}</span>
            </td>
            <td><strong>{{ article.ref }}</strong></td>
            <td>{{ article.designation }}</td>
            <td>
              <span class="badge-pill badge-info">{{ article.nombreDemandes }}</span>
            </td>
            <td>{{ article.quantiteTotale }}</td>
            <td>{{ article.unite }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Affaires (pour utilisateurs non-admin) -->
    <div *ngIf="!isAdministrateur  && stats.affaires && stats.affaires.length > 0" class="table-section">
      <div class="table-header">
        <h3><i class="fas fa-project-diagram"></i> Mes affaires</h3>
        <p>Suivi de vos projets</p>
      </div>
      <div class="affaires-grid">
        <div *ngFor="let affaire of stats.affaires" class="affaire-card">
          <div class="affaire-header">
            <h4>{{ affaire.libelle }}</h4>
            <span class="affaire-code">{{ affaire.code }}</span>
          </div>
          <div class="affaire-stats">
            <div class="affaire-stat">
              <i class="fas fa-file-alt"></i>
              <span>{{ affaire.demandesEnCours }} demandes</span>
            </div>
            <div class="affaire-stat">
              <i class="fas fa-shopping-cart"></i>
              <span>{{ affaire.commandesEnCours }} commandes</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Indicators -->
    <div class="status-row">
      <div class="status-indicator status-success">
        <i class="fas fa-check-circle"></i>
        <div>
          <h4>{{ stats.demandesAchat.recu }}</h4>
          <p>Demandes reçues</p>
        </div>
      </div>

      <div class="status-indicator status-pending">
        <i class="fas fa-clock"></i>
        <div>
          <h4>{{ stats.demandesAchat.envoye }}</h4>
          <p>Demandes envoyées</p>
        </div>
      </div>

      <div class="status-indicator status-draft">
        <i class="fas fa-edit"></i>
        <div>
          <h4>{{ stats.demandesAchat.brouillon }}</h4>
          <p>Brouillons</p>
        </div>
      </div>

      <div class="status-indicator status-rejected">
        <i class="fas fa-times-circle"></i>
        <div>
          <h4>{{ stats.demandesAchat.rejete }}</h4>
          <p>Demandes rejetées</p>
        </div>
      </div>
    </div>

  </div>
</div>
